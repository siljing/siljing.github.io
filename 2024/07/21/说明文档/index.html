<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>learning o 说明文档 | 12321</title><meta name="author" content="Shiling Jing,3182952784@qq.com"><meta name="copyright" content="Shiling Jing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="概述工具函数   功能 类&#x2F;函数 描述    计算类别相似度 get_rehearsal_prototype() 根据 memory 和 memory_o 数据集预测的特征和标签计算每个类别的余弦相似度   预测特征 get_token_features_and_labels() 使用上一轮的模型预测特征   预测隐藏状态序列 get_token_encodings_and_labels">
<meta property="og:type" content="article">
<meta property="og:title" content="learning o 说明文档">
<meta property="og:url" content="https://siljing.github.io/2024/07/21/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/index.html">
<meta property="og:site_name" content="12321">
<meta property="og:description" content="概述工具函数   功能 类&#x2F;函数 描述    计算类别相似度 get_rehearsal_prototype() 根据 memory 和 memory_o 数据集预测的特征和标签计算每个类别的余弦相似度   预测特征 get_token_features_and_labels() 使用上一轮的模型预测特征   预测隐藏状态序列 get_token_encodings_and_labels">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-07-21T03:02:25.000Z">
<meta property="article:modified_time" content="2024-07-21T03:03:45.134Z">
<meta property="article:author" content="Shiling Jing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://siljing.github.io/2024/07/21/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'learning o 说明文档',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-21 11:03:45'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">1</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="12321"><span class="site-name">12321</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">learning o 说明文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-07-21T03:02:25.000Z" title="Created 2024-07-21 11:02:25">2024-07-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-07-21T03:03:45.134Z" title="Updated 2024-07-21 11:03:45">2024-07-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="learning o 说明文档"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h2><table>
<thead>
<tr>
<th>功能</th>
<th>类&#x2F;函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>计算类别相似度</td>
<td><a href="#get_rehearsal_prototype">get_rehearsal_prototype()</a></td>
<td>根据 memory 和 memory_o 数据集预测的特征和标签计算每个类别的余弦相似度</td>
</tr>
<tr>
<td>预测特征</td>
<td><a href="#get_token_features_and_labels">get_token_features_and_labels()</a></td>
<td>使用上一轮的模型预测特征</td>
</tr>
<tr>
<td>预测隐藏状态序列</td>
<td><a href="#get_token_encodings_and_labels">get_token_encodings_and_labels()</a></td>
<td>使用上一轮的模型预测最后一层输出端的隐藏状态序列</td>
</tr>
<tr>
<td>计算类别的原型</td>
<td><a href="#get_exemplar_means">get_exemplar_means()</a></td>
<td>根据支持集的 encoding 计算每个类别的原型，即均值</td>
</tr>
</tbody></table>
<h2 id="准备数据集"><a href="#准备数据集" class="headerlink" title="准备数据集"></a>准备数据集</h2><table>
<thead>
<tr>
<th>功能</th>
<th>类&#x2F;函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>表示训练&#x2F;测试样本的对象</td>
<td><a href="#InputExample">InputExample(object)</a></td>
<td>包含每个样本的编号，单词序列，标签序列</td>
</tr>
<tr>
<td>表示样本特征集的对象</td>
<td><a href="#InputFeatures">InputFeatures(object)</a></td>
<td>包含每个样本特征的 input_ids，input_mask，segment_ids，label_ids</td>
</tr>
<tr>
<td>从文件中读取数据</td>
<td><a href="#read_examples_from_file">read_examples_from_file()</a></td>
<td>返回 InputExample 对象的列表</td>
</tr>
<tr>
<td>提取标签集</td>
<td><a href="#get_labels_dy">get_labels_dy()</a></td>
<td>提取当前任务及之前的所有标签集</td>
</tr>
<tr>
<td>提取每个样本的 InputFeatures 对象</td>
<td><a href="#convert_examples_to_features">convert_examples_to_features</a></td>
<td>将输入的文本样本（通过 InputExample 对象表示）转换为模型输入的特征表示（通过 InputFeatures 对象表示）</td>
</tr>
<tr>
<td>加载并处理数据集样本</td>
<td><a href="#load_and_cache_examples">load_and_cache_examples()</a></td>
<td>调用前两个函数从原始数据集中提取特征</td>
</tr>
</tbody></table>
<h2 id="训练和评估"><a href="#训练和评估" class="headerlink" title="训练和评估"></a>训练和评估</h2><table>
<thead>
<tr>
<th>功能</th>
<th>类&#x2F;函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>老师模型函数</td>
<td><a href="#teacher_evaluate">teacher_evaluate()</a></td>
<td>使用老师模型预测 logits 分数和进行重新标记旧实体类</td>
</tr>
<tr>
<td>评估及重新标记函数</td>
<td><a href="#evaluate">evaluate()</a></td>
<td>评估模型性能以及使用原型对评估集进行重新标记</td>
</tr>
<tr>
<td>训练函数</td>
<td><a href="#train">train()</a></td>
<td>训练模型，更新参数</td>
</tr>
<tr>
<td>训练和评估函数</td>
<td><a href="#train_and_eval">train_and_eval()</a></td>
<td>调用 teacher_evaluate()，evaluate() 和 train() 进行训练和评估</td>
</tr>
</tbody></table>
<h2 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h2><table>
<thead>
<tr>
<th>功能</th>
<th>类&#x2F;函数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>监督对比损失函数</td>
<td><a href="#SupConLoss">SupConLoss()</a></td>
<td>实体的监督对比损失函数</td>
</tr>
<tr>
<td>监督对比损失函数</td>
<td><a href="#SupConLoss_o">SupConLoss_o()</a></td>
<td>实体和“O”的联合监督对比损失函数</td>
</tr>
</tbody></table>
<h2 id="自定义模型"><a href="#自定义模型" class="headerlink" title="自定义模型"></a>自定义模型</h2><p><a href="#MySftBertModel">MySftBertModel()</a></p>
<h2 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h2><p><a href="#mian">main()</a></p>
<h1 id="工具函数-1"><a href="#工具函数-1" class="headerlink" title="工具函数"></a>工具函数</h1><hr>
<p><a id="get_rehearsal_prototype"> </a></p>
<h2 id="get-rehearsal-prototype"><a href="#get-rehearsal-prototype" class="headerlink" title="get_rehearsal_prototype()"></a>get_rehearsal_prototype()</h2><h4 id="参数说明："><a href="#参数说明：" class="headerlink" title="参数说明："></a>参数说明：</h4><p>get_rehearsal_prototype(args, model, tokenizer, labels, pad_token_label_id, mode, data_dir)</p>
<ul>
<li>labels：当前任务及之前的所有标签集</li>
<li>pad_token_label_id：PAD 标记的索引</li>
</ul>
<h4 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h4><ul>
<li>加载当前任务的 memory 和 memory_o 数据集，并用当前模型预测特征和标签。</li>
<li>根据预测特征和标签计算当前任务及之前的所有类别的余弦相似度。</li>
</ul>
<h4 id="测试：对-task0-的-memory-和-memory-o-数据集进行测试："><a href="#测试：对-task0-的-memory-和-memory-o-数据集进行测试：" class="headerlink" title="测试：对 task0 的 memory 和 memory_o 数据集进行测试："></a>测试：对 task0 的 memory 和 memory_o 数据集进行测试：</h4><p><a id="get_token_features_and_labels"> </a></p>
<h2 id="get-token-features-and-labels"><a href="#get-token-features-and-labels" class="headerlink" title="get_token_features_and_labels()"></a>get_token_features_and_labels()</h2><h4 id="参数说明：-1"><a href="#参数说明：-1" class="headerlink" title="参数说明："></a>参数说明：</h4><p>get_token_features_and_labels(args, model, batch)</p>
<ul>
<li>model：当前加载的上一轮的模型</li>
<li>btach：要预测的批次</li>
</ul>
<h4 id="功能："><a href="#功能：" class="headerlink" title="功能："></a>功能：</h4><p>使用上一轮的模型预测特征，并提取出原数据集的标签。<br><a id="get_token_encodings_and_labels"> </a></p>
<h2 id="get-token-encodings-and-labels"><a href="#get-token-encodings-and-labels" class="headerlink" title="get_token_encodings_and_labels()"></a>get_token_encodings_and_labels()</h2><h4 id="功能：-1"><a href="#功能：-1" class="headerlink" title="功能："></a>功能：</h4><p>同 get_token_features_and_labels()，使用上一轮的模型预测最后一层输出端的隐藏状态序列，并提取出原数据集的标签。<br><a id="get_exemplar_means"> </a></p>
<h2 id="get-exemplar-means"><a href="#get-exemplar-means" class="headerlink" title="get_exemplar_means()"></a>get_exemplar_means()</h2><h4 id="功能：-2"><a href="#功能：-2" class="headerlink" title="功能："></a>功能：</h4><p>将每个 label 的所有样本的 encoding 取均值后归一化作为该类别的原型。</p>
<h1 id="准备数据集-1"><a href="#准备数据集-1" class="headerlink" title="准备数据集"></a>准备数据集</h1><hr>
<p><a id="InputExample"></a></p>
<h2 id="InputExample-object"><a href="#InputExample-object" class="headerlink" title="InputExample(object)"></a>InputExample(object)</h2><p>表示一个训练或测试的样本的对象，该类包含以下属性：</p>
<ul>
<li>guid：句子的编号，用作句子的唯一标识符。</li>
<li>words：句子中的单词序列，以列表形式存储。</li>
<li>labels：(可选)序列中每个单词的标签，以列表形式存储。对于测试句子，不需要提供标签列表。</li>
</ul>
<p><a id="InputFeatures"></a></p>
<h2 id="InputFeatures-object"><a href="#InputFeatures-object" class="headerlink" title="InputFeatures(object)"></a>InputFeatures(object)</h2><p>表示一个样本特征集的对象，该类包含以下属性：</p>
<ul>
<li>input_ids：表示单词在词汇表中的索引，是模型输入的主要部分。</li>
<li>input_mask：用于指示哪些部分是真实的输入，哪些部分是填充的。</li>
<li>segment_ids：在BERT处理句子对中，用于区分不同句子的标识，0表示属于第一个句子，1表示属于第二个句子。</li>
<li>label_ids：标签的索引。</li>
</ul>
<p><a id="get_labels_dy"></a></p>
<h2 id="get-labels-dy"><a href="#get-labels-dy" class="headerlink" title="get_labels_dy()"></a>get_labels_dy()</h2><p>get_labels_dy(path, per_types, step_id)</p>
<h4 id="参数说明：-2"><a href="#参数说明：-2" class="headerlink" title="参数说明："></a>参数说明：</h4><ul>
<li>path：标签集的存储路径</li>
<li>per_types：每个任务要学习的标签数量</li>
<li>step_id：当前任务的索引</li>
</ul>
<h4 id="功能：-3"><a href="#功能：-3" class="headerlink" title="功能："></a>功能：</h4><p>返回包含当前任务及之前的所有标签的列表。</p>
<p><a id="read_examples_from_file"></a></p>
<h2 id="read-examples-from-file"><a href="#read-examples-from-file" class="headerlink" title="read_examples_from_file()"></a>read_examples_from_file()</h2><h4 id="参数说明：-3"><a href="#参数说明：-3" class="headerlink" title="参数说明："></a>参数说明：</h4><p>read_examples_from_file(data_dir, mode)</p>
<ul>
<li>data_dir: 数据文件存储的目录，文件读取的路径格式为”data_dir&#x2F;{mode}.txt”</li>
<li>mode：根据不同的模式读取不同的样本<ul>
<li>train：读取 train.txt。</li>
<li>memory：读取 memory.txt。</li>
<li>dev：读取 dev.txt。</li>
<li>rehearsal：同时读取 train.txt 和 memory.txt，并将它们合并成一个列表返回。</li>
</ul>
</li>
</ul>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法:"></a>用法:</h4><ul>
<li>使用 os.path.join 构造文件路径，该路径由 data_dir 和 mode 组成。</li>
<li>打开文件并逐行读取数据。</li>
<li>对于每一行：<ul>
<li>如果行以 “-DOCSTART-“ 开头或为空行，则表示前一个句子的结束。此时，将累积的words和labels作为一个样本添加到 examples 列表中，并清空 words 和 labels 列表。</li>
<li>否则，将行按制表符分割，获取单词和标签，并将它们添加到 words 和 labels 列表中。</li>
</ul>
</li>
<li>返回 examples 列表，其中每个元素都是一个 InputExample 对象，代表一个句子。</li>
</ul>
<p><a id="convert_examples_to_features"></a></p>
<h2 id="convert-examples-to-features"><a href="#convert-examples-to-features" class="headerlink" title="convert_examples_to_features()"></a>convert_examples_to_features()</h2><h4 id="参数说明：-4"><a href="#参数说明：-4" class="headerlink" title="参数说明："></a>参数说明：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">convert_examples_to_features(examples, label_list, max_seq_length, tokenizer, cls_token_at_end=<span class="literal">False</span>, cls_token=<span class="string">&quot;[CLS]&quot;</span>, </span><br><span class="line">                        cls_token_segment_id=<span class="number">1</span>, sep_token=<span class="string">&quot;[SEP]&quot;</span>, sep_token_extra=<span class="literal">False</span>, pad_on_left=<span class="literal">False</span>, pad_token=<span class="number">0</span>, </span><br><span class="line">                        pad_token_segment_id=<span class="number">0</span>, pad_token_label_id=-<span class="number">1</span>, sequence_a_segment_id=<span class="number">0</span>, mask_padding_with_zero=<span class="literal">True</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>examples：经过 read_example_from_file() 函数处理的 InputExample 对象列表</li>
<li>label_list：当前增量学习任务的标签</li>
<li>max_seq_length：tokenization 后的最大序列长度，比这个长的会被截断，比这个短的会被填充。</li>
<li>cls_token_at_end：是否在序列最后加一个 CLS token：<ul>
<li>False (Default, BERT&#x2F;XLM pattern): [CLS] + A + [SEP] + B + [SEP]</li>
<li>True (XLNet&#x2F;GPT pattern): A + [SEP] + B + [SEP] + [CLS]</li>
</ul>
</li>
<li>cls_token_segment_id：定义关于 CLS token 的段id (0 for BERT, 2 for XLNet)。</li>
<li>sep_token_extra：是否在结尾再添加 SEP token( for RoBERTa pattern)。</li>
<li>pad_on_left：是否在句子左边填充 PAD。</li>
</ul>
<h4 id="用法-1"><a href="#用法-1" class="headerlink" title="用法"></a>用法</h4><ul>
<li>将增量学习任务的标签从0编号，构建标签到索引映射 label_map。</li>
<li>遍历每个 example:<ul>
<li>使用分词器 tokenizer 对句子的每个单词进行分词，并在 label_ids 列表中添加它们的标签编号。</li>
<li>根据序列的长度和特殊标记的数量，截断序列，使其长度符合 max_seq_length 的要求。</li>
<li>添加特殊标记 [CLS] 和 [SEP]，以及相应的标签编号。</li>
<li>构建 segment_ids (全为0) 表示句子的段落编号。</li>
<li>构建 input_ids 列表，将 tokens 序列映射为其对应的 ID。</li>
<li>构建输入掩码 input_mask，1 for real tokens and 0 for padding tokens。</li>
<li>对不足长度的序列进行填充。</li>
<li>将每个 example 的处理结果存储为一个 InputFeatures 对象，并添加到 features 列表中。</li>
</ul>
</li>
<li>返回 features 列表。</li>
</ul>
<p><a id="load_and_cache_examples"></a></p>
<h2 id="load-and-cache-examples"><a href="#load-and-cache-examples" class="headerlink" title="load_and_cache_examples()"></a>load_and_cache_examples()</h2><h4 id="参数说明：-5"><a href="#参数说明：-5" class="headerlink" title="参数说明："></a>参数说明：</h4><p>load_and_cache_examples(args, tokenizer, labels, pad_token_label_id, mode, data_dir)</p>
<ul>
<li>tokenizer：分词器</li>
<li>labels: 当前增量学习任务的标签</li>
<li>pad_token_label_id：PAD 位置的掩码</li>
<li>mode：指定当前的模式，可能为 train，dev，rehears。</li>
<li>data_dir: 数据文件存储的目录。</li>
</ul>
<p>data_dir，mode 传入 read_examples_from_file 函数读取样本。<br>tokenizer，传入 convert_examples_to_features 函数将样本转换为特征。</p>
<h4 id="功能：-4"><a href="#功能：-4" class="headerlink" title="功能："></a>功能：</h4><ol>
<li>调用 read_examples_from_file() 和 convert_examples_to_features() 函数，根据不同的模式从 data_dir 中读取样本并转换为特征，如果是’rehearsal’模式，则读取 train.txt 和 memory.txt，如果是开发，训练，测试模式，则读取相应的dev.txt，train.txt，test.txt。</li>
<li>如果是分布式训练的非主进程，直接从缓存文件中加载特征。</li>
<li>返回一个 TensorDataset 对象 dataset(all_input_ids, all_input_mask, all_segment_ids, all_label_ids)。</li>
</ol>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>对 task0 的训练集的句子进行测试：<br><strong>获取标签集</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">labels = get_labels_dy(path=<span class="string">&quot;../data/labels.txt&quot;</span>, per_types=<span class="number">6</span>, step_id=<span class="number">0</span>)</span><br><span class="line">labels</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;O&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;building-library&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;organization-showorganization&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;other-award&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;building-other&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;organization-religion&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;organization-sportsteam&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p><strong>运行 load_and_cache_examples() 函数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_dataset = load_and_cache_examples(args, tokenizer, labels, pad_token_label_id, mode=mode, data_dir=data_dir)</span><br></pre></td></tr></table></figure>
<p>输出日志()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">03/28/2024 13:38:28 - INFO - __main__ -   Creating features from dataset file at ../data/tasks/task_0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   Writing example 0 of 100</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   *** Example ***</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   guid: train-1</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   tokens: [CLS] this rivalry intensified in 1919 when arsenal were unexpectedly promoted to the first division , taking a place that tottenham believed should be theirs . [SEP]</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   input_ids: 101 2023 10685 15767 1999 4529 2043 9433 2020 14153 3755 2000 1996 2034 2407 1010 2635 1037 2173 2008 18127 3373 2323 2022 17156 1012 102 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   input_mask: 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   segment_ids: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   label_ids: -100 0 0 0 0 0 0 6 0 0 0 0 0 0 0 0 0 0 0 0 6 0 0 0 0 0 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   *** Example ***</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   guid: train-2</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   tokens: [CLS] only one of four entered corvette ##s - gt ##1 c ##6 ##r of luc alpha ##nd ave ##nt ##ures - eventually finished the race , taking second place in class . [SEP]</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   input_ids: 101 2069 2028 1997 2176 3133 22687 2015 1011 14181 2487 1039 2575 2099 1997 12776 6541 4859 13642 3372 14900 1011 2776 2736 1996 2679 1010 2635 2117 2173 1999 2465 1012 102 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   input_mask: 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   segment_ids: 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span><br><span class="line">03/28/2024 13:38:28 - INFO - util.supervised_util -   label_ids: -100 0 0 0 0 0 0 -100 0 0 -100 0 -100 -100 0 6 6 -100 6 -100 -100 0 0 0 0 0 0 0 0 0 0 0 0 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100 -100</span><br><span class="line">......仅展示前两个句子</span><br><span class="line">03/28/2024 13:38:28 - INFO - __main__ -   Saving features into cached file ../data/tasks/task_0\cached_rehearsal_output_nerd_128</span><br></pre></td></tr></table></figure>



<h1 id="训练和评估-1"><a href="#训练和评估-1" class="headerlink" title="训练和评估"></a>训练和评估</h1><p><a id="teacher_evaluate"> </a></p>
<h2 id="teacher-evaluate"><a href="#teacher-evaluate" class="headerlink" title="teacher_evaluate()"></a>teacher_evaluate()</h2><h4 id="用法：-1"><a href="#用法：-1" class="headerlink" title="用法："></a>用法：</h4><ol>
<li>使用老师模型，即上一轮的模型预测训练集的 <code>logits_list</code> 和获取真实标签 <code>out_labels</code>。</li>
<li>调用 <a href="#evaluate">evaluate(mode&#x3D;”rehearsal”)</a> 获取训练集的 <code>preds</code>, <code>emissions</code>, <code>out_label_ids</code>, 以及重新标记阈值 <code>prototype_dists</code>。</li>
<li>重新标记旧实体类：对于训练集的每个样本，如果它的原型的相似度大于重新标记阈值，则将该样本预测为这个旧实体类，否则保持原来的预测标签不变。</li>
<li>返回 <code>logits_list</code> 和重新标记过的标签列表 <code>out_label_new_list</code>。</li>
</ol>
<p><a id="evaluate"> </a></p>
<h2 id="evaluate"><a href="#evaluate" class="headerlink" title="evaluate()"></a>evaluate()</h2><h4 id="用法：-2"><a href="#用法：-2" class="headerlink" title="用法："></a>用法：</h4><ol>
<li>加载数据集：调用 <a href="#load_and_cache_examples">load_and_cache_examples()</a> 根据不同模式加载评估集，support 集（提取实体样本），support_o 集（提取“O”样本），训练集。</li>
<li>计算类别原型：</li>
</ol>
<ul>
<li>使用上一轮模型预测支持集的 encoding 和label。</li>
<li>调用 <a href="#get_exemplar_means">get_exemplar_means()</a> 根据支持集的 encoding 和label 计算每个类别的原型。</li>
</ul>
<ol start="3">
<li>调用 <a href="#get_token_encodings_and_labels">get_token_encodings_and_labels()</a> 使用上一轮模型预测评估集的 encoding 和 标签 <code>out_label_ids</code>。</li>
<li>如果是’rehearsal’模式，则剔除掉支持集中当前任务标签的样本，并调用 NNClassification 的 <a href="#nn_classifier_dot_prototype">nn_classifier_dot_prototype()</a> 计算：</li>
</ol>
<ul>
<li><code>preds</code>：评估集每个样本中原型相似度最大值所在的类别索引 </li>
<li><code>emissions</code>：评估集每个样本与每个类别的原型相似度的最大值 </li>
<li><code>prototype_dists</code>：根据支持集计算的每个旧类别的原型重新标记阈值列表</li>
</ul>
<ol start="5">
<li>如果是’rehearsal’模式，则直接返回 <code>preds</code>, <code>emissions</code>, <code>out_label_ids</code>, <code>prototype_dists</code>。</li>
<li>将 <code>out_label_ids</code>，<code>preds</code> 的标签从索引形式转换为真实的字符串形式。</li>
<li>将评估集的 <code>out_label_list</code> 作为真实标签，将 <code>preds_list</code> 作为预测标签，使用 seqeval 库计算 F1 分数 <code>macro_results</code>,<br> <code>micro_results</code>。</li>
<li>返回 <code>macro_results</code>， <code>micro_results</code>，<code>preds_list</code>。</li>
</ol>
<p><a id="train"> </a></p>
<h2 id="train"><a href="#train" class="headerlink" title="train()"></a>train()</h2><h4 id="参数说明：-6"><a href="#参数说明：-6" class="headerlink" title="参数说明："></a>参数说明：</h4><p>train(args, train_dataset, train_dataloader, model, tokenizer, labels, pad_token_label_id, data_dir, output_dir, t_logits, out_new_labels):</p>
<ul>
<li>train_dataset：训练集</li>
<li>train_dataloader：训练集加载器</li>
<li>labels：当前任务及之前的所有真实标签集</li>
<li>pad_token_label_id：PAD 标记的索引</li>
<li>data_dir：输入数据集的文件路径</li>
<li>output_dir：保存模型的检查点的文件路径</li>
<li>t_logits：老师模型预测的 logits 分数</li>
<li>out_new_labels：老师模型预测的标签</li>
</ul>
<h4 id="用法：-3"><a href="#用法：-3" class="headerlink" title="用法："></a>用法：</h4><h6 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h6><ol>
<li>设置训练总步数 t_total（用于传入 warmup 中）：</li>
</ol>
<ul>
<li>通过 <code>args.max_steps</code> 可以指定 t_total，并覆盖 <code>arg.num_train_epochs</code>。</li>
<li>否则通过 <code>t_total = len(train_dataloader) // args.gradient_accumulation_steps * args.num_train_epochs</code> 计算 t_total。</li>
</ul>
<ol start="2">
<li>配置优化器：使用AdamW优化器，使用了权重衰减,学习率调节器。</li>
</ol>
<ul>
<li><code>args.learning_rate</code>(default&#x3D;5e-5) 和 <code>args.adam_epsilon</code>(default&#x3D;1e-8) 可修改AdamW的学习率和模糊因子。</li>
<li><code>args.warmup_steps</code>(default&#x3D;0) 可修改 warmup 的初始预热步数。</li>
</ul>
<ol start="3">
<li>根据 <code>args.fp16</code> 选择是否启用混合精度训练。</li>
</ol>
<h6 id="训练模型："><a href="#训练模型：" class="headerlink" title="训练模型："></a>训练模型：</h6><p>迭代每一轮：</p>
<ol>
<li>如果当前轮次 &gt;&#x3D;  <code>args.start_train_o_epoch</code>：<ul>
<li>利用 <a href="#get_rehearsal_prototype">get_rehearsal_prototype()</a> 函数计算类别相似度</li>
<li>将 <code>loss_name</code> 设为 实体和“O”联合损失函数。</li>
<li>调用 <a href="#get_token_features_and_labels">get_token_features_and_labels()</a> 函数使用当前模型预测特征和标签。</li>
<li>调用 <a href="#get_top_emissions_with_th">get_top_emissions_with_th()</a> 选择“O”的正样本。</li>
</ul>
</li>
<li>如果是第一个任务，使用原始数据集的标签。</li>
<li>如果不是第一个任务，使用老师模型 <a href="#teacher_evaluate">tearch_evaluate()</a> 预测 logits 分数 <code>t_logits</code> 和标签 <code>out_new_labels</code>。</li>
<li>模型前向传播，获取模型输出的损失值。</li>
<li>模型反向传播。</li>
<li>更新参数</li>
<li>调用 <a href="#evaluate">evaluate()</a> 的开发模式对开发集进行评估</li>
<li>达到 <code>args.save_steps</code> 时保存 checkpoint 文件和模型。</li>
<li>返回训练总步数和平均损失值。</li>
</ol>
<p><a id="train_and_eval"> </a></p>
<h2 id="train-and-eval"><a href="#train-and-eval" class="headerlink" title="train_and_eval()"></a>train_and_eval()</h2><h4 id="参数说明：-7"><a href="#参数说明：-7" class="headerlink" title="参数说明："></a>参数说明：</h4><p>train_and_eval(args, labels, num_labels, pad_token_label_id, model_name_or_path, output_dir, data_dir, step_id)</p>
<ul>
<li>labels：当前任务及之前的所有标签集 </li>
<li>num_labels：labels 的数量</li>
<li>pad_token_label_id：PAD 标记的索引</li>
<li>model_name_or_path：加载模型的路径</li>
<li>output_dir：输出结果的文件路径</li>
<li>data_dir：读取数据集的文件路径</li>
<li>step_id：当前任务的 id</li>
</ul>
<h4 id="用法：-4"><a href="#用法：-4" class="headerlink" title="用法："></a>用法：</h4><ol>
<li>加载上一个任务的模型参数，分词器，模型。</li>
<li>调用 <a href="#load_and_cache_examples">load_and_cache_examples(mode&#x3D;”rehearsal”)</a> 加载训练集（由当前任务的 train.txt 和 memory.txt 组成）</li>
<li>如果不是第一个任务，则调用 <a href="#teacher_evaluate">teacher_evaluate(mode&#x3D;”train”)</a> 使用老师模型预测训练集的 logits 分数 <code>t_logits</code> 和 <code>out_new_labels</code>。</li>
<li>调用 <a href="#train">train()</a> 进行训练。</li>
<li>存储模型的参数，分词器，模型。</li>
<li>如果 <code>args.do_eval</code> 为 Ture，对每个 checkpoint 调用 <a href="#evaluate">evaluate()</a> 的开发模式对开发集进行评估，并存储进 eval_results.txt 文件。</li>
<li>如果 <code>args.do_predict</code> 为 Ture，调用 <a href="#evaluate">evaluate()</a> 的测试模式对测试集进行评估和预测，并保存评估和预测结果。</li>
</ol>
<h1 id="损失函数-1"><a href="#损失函数-1" class="headerlink" title="损失函数"></a>损失函数</h1><p><a id="SupConLoss"> </a></p>
<h2 id="SupConLoss"><a href="#SupConLoss" class="headerlink" title="SupConLoss()"></a>SupConLoss()</h2><h4 id="init"><a href="#init" class="headerlink" title="init():"></a><strong>init</strong>():</h4><h6 id="参数说明：-8"><a href="#参数说明：-8" class="headerlink" title="参数说明："></a>参数说明：</h6><p><strong>init</strong>(self, temperature&#x3D;0.07, contrast_mode&#x3D;’all’, base_temperature&#x3D;0.07, topk_th&#x3D;False)</p>
<ul>
<li>temperature：温度参数，用于调整对比损失函数中余弦相似度的尺度。</li>
<li>contrast_mod：</li>
<li>base_temperature：基准温度参数，用于调整对比损失函数的基准尺度。</li>
<li>topk_th：</li>
</ul>
<h4 id="forward"><a href="#forward" class="headerlink" title="forward():"></a>forward():</h4><h6 id="参数说明：-9"><a href="#参数说明：-9" class="headerlink" title="参数说明："></a>参数说明：</h6><p>forward(self, features, labels&#x3D;None, mask&#x3D;None, entity_topk&#x3D;None, ignore_index&#x3D;CrossEntropyLoss(), per_types&#x3D;6, aug_feature&#x3D;None)</p>
<ul>
<li>mask：对比损失的掩码，同一标签的样本设为1，不同为0。</li>
<li>entity_topk: 实体 Top K，表示每个类别的前 K 个样本在对比中的重要性。</li>
<li>ignore_index: 忽略索引，默认为 CrossEntropyLoss()，表示在计算损失时需要忽略的标签索引。</li>
</ul>
<h6 id="用法：-5"><a href="#用法：-5" class="headerlink" title="用法："></a>用法：</h6><ol>
<li>根据输入的 <code>labels</code> 和 <code>mask</code> 构建 <code>mask</code>：不同标签的设为0，与自身的设为0，ignore_index 所对应的行设为0，“O”样本所在行设为0。</li>
<li>选择 Anchor：根据 <code>contrast_mode</code> 选择 anchor 样本，如果 <code>contrast_mode</code> 为 ‘one’, 则将第一个样本设为 anchor，如果 <code>contrast_mode</code> 为 ‘all’, 则将所有样本设为 anchor。</li>
<li>计算对比损失的 Logits：计算 anchor 和其他样本之间的余弦相似度。</li>
<li><code>entity_topk</code> 非空: 将 <code>mask</code> 中所有样本与 entity_topk样本设为1，与当前任务训练集的“O”样本设为 0。</li>
<li>根据监督对比损失函数公式计算损失值，返回所有 anchor 的平均损失值。</li>
</ol>
<h1 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h1><p><a id="MySftBertModel"> </a></p>
<h2 id="MySftBertModel"><a href="#MySftBertModel" class="headerlink" title="MySftBertModel()"></a>MySftBertModel()</h2><h4 id="forward-1"><a href="#forward-1" class="headerlink" title="forward():"></a>forward():</h4><ol>
<li>使用 BertModel 模型前向传播</li>
<li>提取特征 <code>features </code>：将 <code>ast_hidden_state</code> 通过一个 <code>mlp(Linear-ReLU-Linear)</code> 层变换并归一化后赋给 <code>features </code>。</li>
<li>提取 <code>logits</code>：将 <code>last_hidden_state</code> 依次通过dropout 层，线性分类器层后赋给 <code>logits</code>。</li>
<li>如果是非训练模式，直接返回 loss, features_enc, features, logits，其中 <code>loss = None</code>，<code>features_enc = last_hidden_state</code></li>
<li>计算损失值 <code>loss</code>。：<ul>
<li>根据 <code>loss_name</code> 计算损失函数的值。</li>
<li>如果不是第一个任务，计算当前任务样本的 logits 与真实标签的交叉熵损失，当前模型与老师模型 logits 的KL散度。将交叉熵损失或KL散度添加到 <code>loss</code> 中。</li>
</ul>
</li>
<li>返回 loss, features_enc, features, logits。</li>
</ol>
<h1 id="主函数-1"><a href="#主函数-1" class="headerlink" title="主函数"></a>主函数</h1><p><a id="main"> </a></p>
<h2 id="main"><a href="#main" class="headerlink" title="main()"></a>main()</h2><h4 id="功能：-5"><a href="#功能：-5" class="headerlink" title="功能："></a>功能：</h4><ul>
<li>创建解释器，添加命令行参数。</li>
<li>迭代每个任务，调用 <a href="#get_labels_dy">get_labels_dy()</a> 获取当前任务及之前的所有标签集 <code>labels</code>，然后调用 <a href="#train_and_eval">train_and_eval()</a> 进行训练和评估。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://siljing.github.io">Shiling Jing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://siljing.github.io/2024/07/21/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/">https://siljing.github.io/2024/07/21/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Shiling Jing</div><div class="author-info__description">我的个人博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">1</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">工具函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text">准备数据集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E5%92%8C%E8%AF%84%E4%BC%B0"><span class="toc-number">1.3.</span> <span class="toc-text">训练和评估</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">损失函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.</span> <span class="toc-text">自定义模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.</span> <span class="toc-text">主函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0-1"><span class="toc-number">2.</span> <span class="toc-text">工具函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#get-rehearsal-prototype"><span class="toc-number">2.1.</span> <span class="toc-text">get_rehearsal_prototype()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A"><span class="toc-number">2.1.0.2.</span> <span class="toc-text">用法：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%EF%BC%9A%E5%AF%B9-task0-%E7%9A%84-memory-%E5%92%8C-memory-o-%E6%95%B0%E6%8D%AE%E9%9B%86%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%EF%BC%9A"><span class="toc-number">2.1.0.3.</span> <span class="toc-text">测试：对 task0 的 memory 和 memory_o 数据集进行测试：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-token-features-and-labels"><span class="toc-number">2.2.</span> <span class="toc-text">get_token_features_and_labels()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-1"><span class="toc-number">2.2.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="toc-number">2.2.0.2.</span> <span class="toc-text">功能：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-token-encodings-and-labels"><span class="toc-number">2.3.</span> <span class="toc-text">get_token_encodings_and_labels()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%EF%BC%9A-1"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">功能：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-exemplar-means"><span class="toc-number">2.4.</span> <span class="toc-text">get_exemplar_means()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%EF%BC%9A-2"><span class="toc-number">2.4.0.1.</span> <span class="toc-text">功能：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E9%9B%86-1"><span class="toc-number">3.</span> <span class="toc-text">准备数据集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#InputExample-object"><span class="toc-number">3.1.</span> <span class="toc-text">InputExample(object)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InputFeatures-object"><span class="toc-number">3.2.</span> <span class="toc-text">InputFeatures(object)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-labels-dy"><span class="toc-number">3.3.</span> <span class="toc-text">get_labels_dy()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-2"><span class="toc-number">3.3.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%EF%BC%9A-3"><span class="toc-number">3.3.0.2.</span> <span class="toc-text">功能：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#read-examples-from-file"><span class="toc-number">3.4.</span> <span class="toc-text">read_examples_from_file()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-3"><span class="toc-number">3.4.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95"><span class="toc-number">3.4.0.2.</span> <span class="toc-text">用法:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#convert-examples-to-features"><span class="toc-number">3.5.</span> <span class="toc-text">convert_examples_to_features()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-4"><span class="toc-number">3.5.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95-1"><span class="toc-number">3.5.0.2.</span> <span class="toc-text">用法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load-and-cache-examples"><span class="toc-number">3.6.</span> <span class="toc-text">load_and_cache_examples()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-5"><span class="toc-number">3.6.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%EF%BC%9A-4"><span class="toc-number">3.6.0.2.</span> <span class="toc-text">功能：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.6.0.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E5%92%8C%E8%AF%84%E4%BC%B0-1"><span class="toc-number">4.</span> <span class="toc-text">训练和评估</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#teacher-evaluate"><span class="toc-number">4.1.</span> <span class="toc-text">teacher_evaluate()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A-1"><span class="toc-number">4.1.0.1.</span> <span class="toc-text">用法：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#evaluate"><span class="toc-number">4.2.</span> <span class="toc-text">evaluate()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A-2"><span class="toc-number">4.2.0.1.</span> <span class="toc-text">用法：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#train"><span class="toc-number">4.3.</span> <span class="toc-text">train()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-6"><span class="toc-number">4.3.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A-3"><span class="toc-number">4.3.0.2.</span> <span class="toc-text">用法：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.0.2.0.1.</span> <span class="toc-text">参数配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B%EF%BC%9A"><span class="toc-number">4.3.0.2.0.2.</span> <span class="toc-text">训练模型：</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#train-and-eval"><span class="toc-number">4.4.</span> <span class="toc-text">train_and_eval()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-7"><span class="toc-number">4.4.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A-4"><span class="toc-number">4.4.0.2.</span> <span class="toc-text">用法：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0-1"><span class="toc-number">5.</span> <span class="toc-text">损失函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SupConLoss"><span class="toc-number">5.1.</span> <span class="toc-text">SupConLoss()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init"><span class="toc-number">5.1.0.1.</span> <span class="toc-text">init():</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-8"><span class="toc-number">5.1.0.1.0.1.</span> <span class="toc-text">参数说明：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#forward"><span class="toc-number">5.1.0.2.</span> <span class="toc-text">forward():</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%EF%BC%9A-9"><span class="toc-number">5.1.0.2.0.1.</span> <span class="toc-text">参数说明：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9A-5"><span class="toc-number">5.1.0.2.0.2.</span> <span class="toc-text">用法：</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B"><span class="toc-number">6.</span> <span class="toc-text">模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySftBertModel"><span class="toc-number">6.1.</span> <span class="toc-text">MySftBertModel()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#forward-1"><span class="toc-number">6.1.0.1.</span> <span class="toc-text">forward():</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0-1"><span class="toc-number">7.</span> <span class="toc-text">主函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main"><span class="toc-number">7.1.</span> <span class="toc-text">main()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%EF%BC%9A-5"><span class="toc-number">7.1.0.1.</span> <span class="toc-text">功能：</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/21/%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/" title="learning o 说明文档">learning o 说明文档</a><time datetime="2024-07-21T03:02:25.000Z" title="Created 2024-07-21 11:02:25">2024-07-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Shiling Jing</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>